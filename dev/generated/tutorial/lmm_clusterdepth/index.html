<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>MixedModels EEG + Cluster permutation test · UnfoldStats.jl</title><meta name="title" content="MixedModels EEG + Cluster permutation test · UnfoldStats.jl"/><meta property="og:title" content="MixedModels EEG + Cluster permutation test · UnfoldStats.jl"/><meta property="twitter:title" content="MixedModels EEG + Cluster permutation test · UnfoldStats.jl"/><meta name="description" content="Documentation for UnfoldStats.jl."/><meta property="og:description" content="Documentation for UnfoldStats.jl."/><meta property="twitter:description" content="Documentation for UnfoldStats.jl."/><meta property="og:url" content="https://unfoldtoolbox.github.io/UnfoldStats.jl/generated/tutorial/lmm_clusterdepth/"/><meta property="twitter:url" content="https://unfoldtoolbox.github.io/UnfoldStats.jl/generated/tutorial/lmm_clusterdepth/"/><link rel="canonical" href="https://unfoldtoolbox.github.io/UnfoldStats.jl/generated/tutorial/lmm_clusterdepth/"/><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../search_index.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">UnfoldStats.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="../../../tutorial/test_single_coefficient/">Two-stage single parameter test (t-test)</a></li><li><a class="tocitem" href="../test_splines/">Two-stage multi parameter test (Hotelling&#39;s T-squared test)</a></li><li class="is-active"><a class="tocitem" href><strong>MixedModels</strong> EEG + Cluster permutation test</a><ul class="internal"><li><a class="tocitem" href="#0.-Setup"><span>0. Setup</span></a></li><li><a class="tocitem" href="#1.-Simulate-data"><span>1. Simulate data</span></a></li><li><a class="tocitem" href="#2.-Fit-mass-univariate-LMMs"><span>2. Fit mass-univariate LMMs</span></a></li><li><a class="tocitem" href="#3.-Cluster-permutation-test"><span>3. Cluster permutation test</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href><strong>MixedModels</strong> EEG + Cluster permutation test</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href><strong>MixedModels</strong> EEG + Cluster permutation test</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/unfoldtoolbox/UnfoldStats.jl/blob/main/docs/literate/tutorial/lmm_clusterdepth.jl#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><div class="admonition is-category-important"><header class="admonition-header">Important</header><div class="admonition-body"><p>This functionality is not extensively tested. While it returns reasonable results, we haven&#39;t written any unit-tests, nor tested the type-1 error probability yet</p></div></div><h2 id="0.-Setup"><a class="docs-heading-anchor" href="#0.-Setup">0. Setup</a><a id="0.-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#0.-Setup" title="Permalink"></a></h2><p>If you want to do LMM + cluster permutations, you at least need these packages (more for the simulation below)</p><pre><code class="language-julia hljs">using UnfoldMixedModels
using MixedModelsPermutations, ClusterDepth
using UnfoldStats</code></pre><h2 id="1.-Simulate-data"><a class="docs-heading-anchor" href="#1.-Simulate-data">1. Simulate data</a><a id="1.-Simulate-data-1"></a><a class="docs-heading-anchor-permalink" href="#1.-Simulate-data" title="Permalink"></a></h2><p>This section can be skipped, if one already has (real) data that they want to analyse.</p><details>
<summary>Click to expand the simulation details</summary><pre><code class="language-julia hljs">using UnfoldSim
using StatsModels
using Random

srate = 25
design = MultiSubjectDesign(;
    n_subjects = 30,
    n_items = 40,
    items_between = Dict(:stimtype =&gt; [&quot;car&quot;, &quot;face&quot;]),
)
#both_within = Dict(:condition=&gt;[&quot;scrambled&quot;,&quot;intact&quot;]))
contrasts = Dict(:stimtype =&gt; DummyCoding())
p1 = MixedModelComponent(;
    basis = UnfoldSim.p100(; sfreq = srate),
    formula = @formula(dv ~ 1 + (1 | subject) + (1 | item)),
    β = [5.0],
    σs = Dict(:subject =&gt; [0.0], :item =&gt; [0.0]),
    contrasts = contrasts,
);

n1 = MixedModelComponent(;
    basis = UnfoldSim.n170(; sfreq = srate),
    formula = @formula(dv ~ 1 + stimtype + (1 + stimtype | subject) + (1 | item)),
    β = [1.0, 4], # n170-basis is negative
    σs = Dict(:subject =&gt; [2.0, 0.25], :item =&gt; [0.25]),
    contrasts = contrasts,
);

p3 = MixedModelComponent(;
    basis = UnfoldSim.p300(; sfreq = srate),
    formula = @formula(dv ~ 1 + (1 | subject) + (1 + stimtype | item)),
    β = [4.0],
    σs = Dict(:subject =&gt; [1.0], :item =&gt; [0.5, 2]),
    contrasts = contrasts,
);



data_e, events = UnfoldSim.simulate(
    design,
    [p1, n1, p3],
    UniformOnset(srate * 2, 10),
    PinkNoise(; noiselevel = 1);
    return_epoched = true,
)
times = range(-0.1, 0.5, length = size(data_e, 1))
data_e = reshape(data_e, 1, size(data_e, 1), :)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr33"><span class="sgr1">┌ Warning: </span></span>No random generator defined, used the default (`Random.MersenneTwister(1)`) with a fixed seed. This will always return the same results and the user is strongly encouraged to provide their own random generator!
<span class="sgr33"><span class="sgr1">└ </span></span><span class="sgr90">@ UnfoldSim ~/.julia/packages/UnfoldSim/JzrqI/src/simulation.jl:17</span></code></pre></details ><h2 id="2.-Fit-mass-univariate-LMMs"><a class="docs-heading-anchor" href="#2.-Fit-mass-univariate-LMMs">2. Fit mass-univariate LMMs</a><a id="2.-Fit-mass-univariate-LMMs-1"></a><a class="docs-heading-anchor-permalink" href="#2.-Fit-mass-univariate-LMMs" title="Permalink"></a></h2><p>We have some typical experimental data with subject and item effects. Item refer to stimuli here, based on our <code>stimtype</code> condition these are either different <code>cars</code> or <code>faces</code>.</p><pre><code class="language-julia hljs">m = fit(
    UnfoldModel,
    [
        Any =&gt; (
            @formula(0 ~ 1 + stimtype + (1 + stimtype | item) + (1 + stimtype | subject)),
            times,
        ),
    ],
    events,
    data_e,
);</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi"><span class="sgr32">Progress:  17%|██████▉                                  |  ETA: 0:00:10</span>
<span class="sgr34">  channel:  1</span>
<span class="sgr34">  time:     2</span>

<span class="sgr32">Progress: 100%|█████████████████████████████████████████| Time: 0:00:02</span>
<span class="sgr34">  channel:  1</span>
<span class="sgr34">  time:     12</span></code></pre><h2 id="3.-Cluster-permutation-test"><a class="docs-heading-anchor" href="#3.-Cluster-permutation-test">3. Cluster permutation test</a><a id="3.-Cluster-permutation-test-1"></a><a class="docs-heading-anchor-permalink" href="#3.-Cluster-permutation-test" title="Permalink"></a></h2><p>If we would run a statistical test on each time-point separately, we would greatly inflate the type-1 error, reaching significance on any each sample much higher than the assumed α=0.05. One solution are cluster permutation test, where we instead test for clustersizes of connected significant clusters. In &quot;classical&quot; two-stage testing, such a permutation test is straight forward. But for LMMs we have to think of something more clever, as it is not directly clear how to permute if both subject and item effects exist (you gonna break the relation between the two). We did that in <code>MixedModelsPermutations</code> and can apply this strategy to EEG data as well.`</p><p>select the fixed-effects coefficient to test (<code>stimtype</code>)</p><pre><code class="language-julia hljs">coefficient = 2;</code></pre><p>call the permutation test</p><div class="admonition is-info"><header class="admonition-header">Note</header><div class="admonition-body"><p>This interface is very likely to change in the future</p></div></div><pre><code class="language-julia hljs">pvalue(
    MersenneTwister(1),
    m,
    data_e,
    coefficient;
    n_permutations = 20,
    clusterforming_threshold = 1.8,
)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">1×12 Matrix{Float64}:
 1.0  1.0  1.0  0.0666667  0.0666667  1.0  1.0  1.0  1.0  1.0  1.0  1.0</code></pre><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../test_splines/">« Two-stage multi parameter test (Hotelling&#39;s T-squared test)</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.1 on <span class="colophon-date" title="Tuesday 25 February 2025 17:22">Tuesday 25 February 2025</span>. Using Julia version 1.11.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
